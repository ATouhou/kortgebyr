<!DOCTYPE html>
<html>
<script>

var NUMBER_OF_ACQUIRERS = 5;

function $(e)
{
	return document.getElementById(e);
}

var base64_chars =  "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/";

function base64_encode(n)
{
	if(n<0){
		return "";
	}
	var str = "",curr_n = n;
	do{
		str = base64_chars[ curr_n%64 ] + str;
		curr_n = Math.floor( curr_n/64 );
	}
	while(curr_n !== 0);
	return str;
}

var URL_OBJECT = 
[	
	{
		bits:1,
		get: function(){
			return + $("dankort").checked;
		},
		set: function(i){
			$("dankort").checked = i !== 0;
		}
	},
	{
		bits:1,
		get: function(){
			return + $("visa_mastercard").checked;
		},
		set: function(i){
			$("visa_mastercard").checked = i !== 0;
		}
	},
	{
		bits:1,
		get: function(){
			return + $("3dsecure").checked;
		},
		set: function(i){
			$("3dsecure").checked = i !== 0;
		}
	},
	{
		bits:1,
		get: function(){
			return + $("fraud_fighter").checked;
		},
		set: function(i){
			$("fraud_fighter").checked = i !== 0;
		}
	},
	{
		bits:4, // == op til 16 indløsere, før linkstruktur skal ændres
		get: function(){
			return parseInt( $("acquirer").selectedIndex );
		},
		set: function(i){
			$("acquirer").selectedIndex = i ;
		}
	},
	// Dirty bits = antal acquirers
	{
		bits: NUMBER_OF_ACQUIRERS,
		get: function(){
			return 17;// detect de acquirers der er ændret i og konverter til binary
					  // 17 => nummber 1 og nummer 5
		},
		set: function(i){
			console.log(i);
		}
	}
];

var MAX_INT32 = 0x7FFFFFFF;


function save_url_variables()
{	
	var url = "" ,first_bit = 0 // from left
	, sum=0;
	for( var i in URL_OBJECT){
		var obj = URL_OBJECT[i], remainder = obj.get(), remainder_bits = obj.bits;
		
		do{
			var last_bit = Math.min( first_bit + remainder_bits - 1, 5 );
			sum +=  remainder >>> Math.max( remainder_bits - ( 1 +  last_bit - first_bit) , 0) << ( 5 - last_bit );
			remainder_bits -= 1 + last_bit - first_bit;
			remainder = remainder &  ( MAX_INT32 >>> (31 - remainder_bits ) ) ;
			if ( last_bit === 5 || parseInt(i)=== URL_OBJECT.length-1 ) {
				url += base64_chars.charAt(sum);
				first_bit = 0;
				sum = 0;
			}
			else{
				first_bit += last_bit - first_bit + 1;
			}
		} while(remainder_bits > 0);
	}	
	history.pushState({foo:"bar"} , "" , "?"+url);
}

function get_bit_range(n , from , to)
{
	 // fra venstre --- kun til 6-bit
	return (n & ( MAX_INT32 >>> (31 - 6 + from ) )) >>> 5-to;
}

function load_url_variables(url_query)
{
	url_query = url_query.replace("?","");
	if(url_query === ""){
		return;
	}
	var current_char_num = 0,first_bit = 0; // 0 char is ?
	for( var i in URL_OBJECT){
		var obj = URL_OBJECT[i], sum = 0;
		var remaining_bits = obj.bits;
		while(1){
			if(current_char_num > url_query.length - 1){
				return; // error url_query too short
			}
			var current_char = url_query.charAt( current_char_num );
			var n = base64_chars.indexOf( current_char );
			if( n === -1 ){
				return; // error invalid char
			}
			var last_bit =  first_bit + remaining_bits - 1;
			if( last_bit > 5){
				last_bit = 5;
			}
			remaining_bits -= 1 + last_bit - first_bit; 
			sum += get_bit_range( n , first_bit,last_bit) << remaining_bits;
			if(remaining_bits > 0){
				first_bit = 0;
				current_char_num ++;
			}
			else{
				first_bit = last_bit + 1;
				if( first_bit > 5 ){
					first_bit = 0;
					current_char_num ++;
				}
				break;
			}
		}
		obj.set(sum);
	}
	
}

window.onload = function(){
	load_url_variables(location.search);
}

</script>

<body>
	
	<div>dankort: <input type="checkbox" id="dankort" checked></div>
	<div>visamc: <input type="checkbox" id="visa_mastercard" checked></div>
	<div>3dsecure: <input type="checkbox" id="3dsecure" checked></div>
	<div>fraudfighter: <input type="checkbox" id="fraud_fighter" checked></div>
	<div><select id="acquirer">
		<option id="acq_auto">Automatisk</option>
		<option id="acq_teller">Teller</option>
		<option id="acq_seb">SEB Euroline</option>
		<option id="acq_swedbank" selected>Swedbank</option>
		<option id="acq_handelsbanken">Handelsbanken</option>
		<option id="acq_valitor">Valitor</option>
	</select></div>
	
<button onclick="save_url_variables()">Extract</button>

</body>
</html>